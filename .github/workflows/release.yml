name: release

on:
  schedule:
  - cron: '0 19 * * *'
  push:
    branches: [ master, test ]
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  release:
    runs-on: ubuntu-18.04
    steps:
      - name: Install neovim
        run: |
          wget -o/dev/null -Onvim.tgz "https://github.com/neovim/neovim/releases/download/stable/nvim-linux64.tar.gz"
          tar xzf nvim.tgz
          sudo cp -rf ./nvim-linux64/* /usr/local
          nvim --version

      - uses: actions/checkout@v2
      - name: Prepare mini config
        run: |
          pwd && ls
          mkdir -p ~/.config
          cp -r mini_config ~/.config/nvim
          cp -r snippets ~/.config/nvim
          cp config.lua basic.vim ~/.config/nvim
          pushd ~/.config
          nvim --headless -c 'PlugUpdate --sync|qa'
          7z -mx9 a mini_config.zip ./nvim
          nvim --headless -c "LspInstall ccls" -c "sleep 10" -c "qa"
          7z -mx9 a mini_config_with_ccls.zip ./nvim
          popd
          mv ~/.config/*.zip .

      - uses: dev-drprasad/delete-tag-and-release@v0.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          delete_release: true
          tag_name: mini_config

      - uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: mini_config
          artifactErrorsFailBuild: true
          allowUpdates: true
          replacesArtifacts: true
          removeArtifacts: true
          artifacts: "*.zip"
          body: |
            mini_config only work with [NeoVim](https://github.com/neovim/neovim/releases/latest)

            ### Optional dependencies
            [ripgrep](https://github.com/BurntSushi/ripgrep)
            [ccls](https://github.com/MaskRay/ccls)

