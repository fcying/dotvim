name: release

on:
  schedule:
  - cron: '0 19 * * *'
  push:
    branches: [ master, test ]
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  release:
    runs-on: ubuntu-18.04
    steps:
      - name: Install neovim
        run: |
          wget -o/dev/null -Onvim.tgz "https://github.com/neovim/neovim/releases/download/stable/nvim-linux64.tar.gz"
          tar xzf nvim.tgz
          sudo cp -rf ./nvim-linux64/* /usr/local
          nvim --version

      - uses: actions/checkout@v2
      - name: Prepare nvim config
        run: |
          pwd && ls
          mkdir -p ~/.config
          cp -r nvim_config ~/.config/nvim
          cp -r snippets ~/.config/nvim
          cp config.lua basic.vim ~/.config/nvim
          pushd ~/.config
          nvim --headless -c 'PlugUpdate --sync|qa'
          7z -mx9 a nvim_config.zip ./nvim
          nvim --headless -c 'LspInstall --sync clangd' -c 'q'
          7z -mx9 a nvim_config_with_lsp.zip ./nvim
          popd
          mv ~/.config/*.zip .

      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          {
            echo "nvim_config work with [NeoVim](https://github.com/neovim/neovim/releases/latest)"
            echo -e "\n"
            echo "### Optional dependencies"
            echo "[ripgrep](https://github.com/BurntSushi/ripgrep)"
          } | tee /tmp/note.md
          gh release delete nvim_config -y || true
          gh release create nvim_config -t "nvim_config" -F "/tmp/note.md" --target $GITHUB_SHA *.zip
